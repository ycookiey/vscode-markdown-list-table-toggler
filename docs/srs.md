# Markdown List-Table Toggler 仕様詳細設計書

## 1. プロダクト概要
*   **名称**: Markdown List-Table Toggler
*   **プラットフォーム**: VS Code Extension
*   **目的**: Markdownにおける「リスト（書きやすさ）」と「テーブル（閲覧性）」の障壁をなくし、相互変換によって構造化データの作成・管理を効率化する。
*   **基本原則**:
    *   **Context-Aware**: カーソル位置から自動でブロックを認識し、変換方向（List⇔Table）を判定する。
    *   **Non-Destructive**: 変換によって情報（キー、値、ネスト構造）を失わない。

## 2. 基本動作とUX

### 2.1. トリガーと範囲選択
*   **トリガー**: コマンド `Toggle List/Table` (Shortcut: `Ctrl+Shift+T` 推奨)。
*   **スマートブロック認識**:
    *   ユーザーによる範囲選択は不要。
    *   カーソル位置の行を起点とし、**上下の「空行」または「ファイル端」** までを一つの変換対象ブロックとして自動認識する。
    *   例外: カーソルが空行上にある場合は実行しない。

### 2.2. モード自動判定
*   選択ブロックの行頭記号を解析し、モードを決定する。
    *   `|` で始まる行が多ければ **Table → List**。
    *   `-`, `*`, `1.` 等で始まる行が多ければ **List → Table**。

---

## 3. 変換ロジック詳細

### 3.1. List → Table (LT変換)

#### データ解析 (Parsing)
*   **ルート要素 (Row)**: リストの第1階層を「行」とする。
*   **チェックボックス**: `- [ ]`, `- [x]` はリストマーカーとして除去せず、**テキストの一部として保持**する（タスクリスト対応）。
*   **ヘッダー生成 (Superset Logic)**:
    *   ブロック内の**全Item**をスキャンし、存在するすべてのユニークなキー（Key）を収集する。
    *   **順序**: 最初に出現した順（Appearance Order）を維持。
*   **ハイブリッド・データ処理**:
    1.  **Key: Value**: キー名をヘッダーとしてマッピング。
    2.  **Valueのみ**: その行内での出現順に `Col1`, `Col2`... というヘッダーを付与し、**テーブルの右端**に配置する。

#### 特殊文字・構造処理
*   **ネスト (Flattening)**:
    *   第2階層以降はドット記法で結合（例: `Parent.Child`）。
    *   キー名自体に含まれるドット（例: `ver1.5`）は `ver1\.5` にエスケープし、構造区切りと区別する。
*   **パイプ (`|`)**: 値に含まれるパイプは `\|` にエスケープする（※コードブロック内のパイプを除く）。
*   **改行**: 値の中の改行は `<br>` タグに変換する。

### 3.2. Table → List (TL変換)

#### リスト生成 (Stringify)
*   **ヘッダー復元**: テーブルヘッダーをリストの「Key」として出力する。
    *   `Col1` などの自動生成ヘッダーも、`- Col1: Value` として明示的に出力する（データ順序保証のため）。
*   **値のクォート戦略**:
    *   デフォルト (`none`) では、値をクォートせず生のテキストとして出力する（視認性重視）。
    *   値に含まれるコロン (`12:00`) はエスケープしない（読み込み側のパーサーで対応するため）。
*   **パイプ (`\|`)**: エスケープを解除し、`|` に戻す。
*   **改行 (`<br>`)**: リスト上での改行（`\n` + インデント）に復元する。

---

## 4. エディタ支援機能（Language Features）

### 4.1. Block-Scoped Rename (F2)
*   **機能**: リスト内のキー（例: `Price`）上で `F2` を押すと、**現在のリストブロック内にある同名のキーのみ**を対象にリネームを実行する。
*   **技術**: `vscode.RenameProvider` を実装し、影響範囲をブロック内に限定する。

### 4.2. Block-Scoped Highlight
*   **機能**: カーソル位置のキーと同じキーを、**現在のリストブロック内**でハイライト表示する。
*   **技術**: `vscode.DocumentHighlightProvider`。

### 4.3. Input Auto-Completion (Snippet)
*   **機能**: リスト入力中、改行して `- ` を打った際、**直前の行の構造（キーセット）**を推測して補完候補に出す。
*   **挙動**: 確定するとスニペットが展開され、`Tab` キーで値の入力欄を移動できる。

### 4.4. Table Prettify
*   **機能**: LT変換時、全角文字（East Asian Width）を考慮して列幅を計算し、パイプの位置を揃える。

---

## 5. コンフィグ設定 (Configuration)

`package.json` に定義する設定項目。

| 設定キー | 型 | デフォルト | 説明 |
| :--- | :--- | :--- | :--- |
| `rootHeaderName` | string | `"Item"` | テーブル1列目（主キー）のヘッダー名。 |
| `outputEmptyKeys` | boolean | `true` | TL変換時、値が空のセルに対応するキーを出力するか。<br>`true`: `- Key:`<br>`false`: 行ごと省略 |
| `valueEscapeStyle` | string | `"none"` | TL変換時、値をどう囲むか。<br>`"none"`: 囲まない (Raw)<br>`"smart"`: 必要時のみ `"`<br>`"always"`: 常に `"` |
| `listMarkerStyle` | string | `"bullet"` | TL変換時のリスト記号。<br>`"bullet"`: `- `<br>`"ordered"`: `1. `<br>`"asterisk"`: `* ` |
| `formatTable` | boolean | `true` | LT変換時、テーブルの列幅を整形するか。 |
| `smartPipeEscape` | boolean | `true` | コードブロックや数式内の `\|` エスケープを回避するか。 |
| `flattenNestedKeys` | boolean | `true` | 深い階層を `Parent.Child` 形式でテーブル化するか。 |

---

## 6. 技術スタック・実装方針
*   **Language**: TypeScript
*   **Parser Logic**:
    *   厳密なYAMLパーサーは使用せず、Markdown専用の**行指向パーサー**を自作する。
    *   **Split Logic**: `line.split(/: (.*)/s)` （最初の `: ` で分割）を採用し、値の中のコロンを許容する。
*   **Formatting**:
    *   `wcwidth` (または同等の軽量ライブラリ) を使用し、全角文字幅を正しく計算する。

---

## 7. エッジケース対応表

| ケース | 入力例 | 挙動 |
| :--- | :--- | :--- |
| **値内のコロン** | `- Time: 12:00` | 正常に `Time` と `12:00` に分割される。TL変換時はそのまま出力。 |
| **値内のパイプ** | `- A: x | y` | LT変換で `x \| y` にエスケープ。TL変換で `x | y` に戻る。 |
| **キー内のドット** | `- ver1.5: val` | LT変換ヘッダーは `ver1\.5`。TL変換時はネストせずキーとして復元。 |
| **チェックボックス** | `- [x] Task` | テーブルセルには `[x] Task` という文字列が入る。削除されない。 |
| **混在データ** | `- A`<br>`  - 100`<br>`  - K: V` | `| Item | K | Col1 |`<br>`| A | V | 100 |` (構造化データ優先、残りは右寄せ) |
| **空セル** | テーブルの空欄 | 設定 `outputEmptyKeys: true` なら `- Key:` を生成。 |